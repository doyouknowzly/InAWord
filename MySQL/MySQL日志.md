# MySQL架构

| 序号 | 问题                                    | 一句话解释                                                   | 详细知识点                                                   |
| ---- | --------------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 0    | MySQL的架构分层                         | 客户端;<br>连接器、缓存层、分析器、优化器、执行器;<br>存储引擎层 |                                                              |
| 1    | MySQL的日志有哪些                       | **常用**: 重做日志（redo log）、回滚日志（undo log）、二进制日志（binlog） <br>**不常用**: 错误日志（errorlog）、慢查询日志（slow query log）、一般查询日志（general log），中继日志（relay log） |                                                              |
| 1    | redo log的作用                          | 增加服务的吞吐量<br>使得服务高可用                           | [极客时间<02日志系统：一条SQL更新语句是如何执行的？>](https://time.geekbang.org/column/article/68633) |
| 2    | redo log的写入过程                      | 其实redo log的写入过程就是**2阶段提交(2PC)**.<br>零、执行器调用引擎写入数据，写到了redo log<br>一、redo log写入后，处于prepare状态 <br>二、执行器生成binlog,并写入磁盘 <br>三、执行器调用引擎接口提交，引擎将redo log的状态流转，从prepare -> commit<br> |                                                              |
| 3    | redo log 写入过程中如果宕机了，怎么办？ | 1 prepare阶段 2 写binlog 3 commit<br>**当在2之前崩溃时**,重启恢复：发现没有commit，回滚。备份恢复：没有binlog 。和崩溃前一致<br>**当在3之前崩溃**重启恢复：虽没有commit，但满足prepare和binlog完整，所以重启后会自动commit.备份恢复：有binlog. 一致 |                                                              |
| 3    | binlog的作用                            | **binlog**(归档日志) 是逻辑日志, 逻辑的意思是，迁移到其他MySQL实例上也行，即使其他的是MyISAM。<br>主要作用:**备份恢复and主从复制** |                                                              |
| 4    | binlog的格式                            | 3种格式， 一般推荐使用row格式<br>一、row : 基于行的模式，记录的是行的变化，很安全<br>二、statement : 基于SQL语句的模式，某些语句中含有一些函数，例如 UUID NOW 等在复制过程可能导致数据不一致甚至出错<br>三、mixed : 混合模式，根据语句来选用是 statement 还是 row 模式 |                                                              |
| 5    | redo log和bin log的关联                 | redo log 和 binlog 有一个共同的数据字段叫 **XID**。崩溃恢复的时候会按顺序扫描 redo log。<br>如果碰到既有 prepare、又有 commit 的 redo log就直接提交<br>如果碰到只有 parepare、而没有 commit 的 redo log就拿着 XID 去 binlog 找对应的事务。 |                                                              |

## 详细知识点阐述  
### 0. MySQL的架构分层
   - 1.客户端，我们自己的服务 <br>
   - 2.连接器，包括授权认证、连接处理等；
   - 3.缓存层，如果命中内存就直接返回了，不用查文件系统. 但查询缓存的失效非常频繁，只要有对一个表的更新，这个表上所有的查询缓存都会被清空。<br>**注意:MySQL 8.0 版本直接将查询缓存的整块功能删掉了，也就是说 8.0 开始彻底没有这个功能了** <br>
   - 4.分析器，有点像编译器的分词器，进行词法分析、语法分析<br>
   - 5.优化器，执行计划的生成，选择合适的索引等 <br>
   - 6.执行器，操作API，返回结果<br>
   - 7.存储引擎层，去实现MySQL的Api, 但不解析Sql。比如InnoDb和MyISAM<br>其中，除了引擎层，其他的都属于Server层  

## MySQL日志的对比
| 日志     | 别名       | 作用                                           | 内容                                                         | 存储 | write方式 | 适用场景                             |
| -------- | ---------- | ---------------------------------------------- | ------------------------------------------------------------ | ---- | --------- | ------------------------------------ |
| binlog   | 二进制日志 | 数据的真正存储                                 | **逻辑格式的日志 **<br>简单理解就是sql本身，读sql不记录<br>**还记录着sql的回滚sql**，比如1条insert,也会同时有1条delete |      |           | 主从复制、数据恢复(某一刻)、集群同步 |
| redo log | 重做日志   | 确保事务的持久性                               | **物理格式的日志**，记录的是物理数据页面的修改的信息，顺序地写入物理文件中去的 |      |           | 事务的崩溃恢复                       |
| undo log | 回滚日志   | 提供多版本并发控制下的读（MVCC），也即非锁定读 | 逻辑格式的日                                                 |      |           | 事务回滚                             |

### 1. redo log的作用
   - **redo log**（重做日志）是物理日志， 记录每次客户端的更新操作，比如update 、insert等；<br>写redo log的方式，是WAL技术，即Write-Ahead Logging, 核心就是:**先写日志，再更新磁盘文件**<br>因为磁盘文件更新很慢，要定位、磁盘寻址、修改，所以就先记在redo log上，有空的时候再更新。<br>
   - **作用**:
        - 1、**增加服务的吞吐**，因为写日志是增量追加，很快啊 <br>
        - 2、**高可用**，即使服务重启、死掉，也可以从redo log 恢复，称为 **crash-safe**
            - 注意:**redo log 是InnoDb引擎引入的，Server层并没有redo log**，即MyISAM引擎并没有**crash-safe**能力<br>