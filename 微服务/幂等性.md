# 幂等性



## 一、概念

幂等概念来自数学，表示N次变换和1次变换的结果是相同的。

在互联网行业中，一般是指:

- 客户端在调用服务没有达到预期结果时，会进行多次调用，为避免多次重复的调用对服务资源产生副作用，服务提供者会承诺满足幂等

- 声明为幂等的服务会认为外部调用失败是常态，并且失败之后必然会有重试。

> HTTP/1.1中对幂等性的定义是：一次和多次请求某一个资源**对于资源本身**应该具有同样的副作用（网络超时等问题除外）。
>
> 也就是说，**其任意多次执行对资源本身所产生的影响均与一次执行的影响相同**。



几个需要**额外**关注的点: 

1. 网络超时等问题，不是幂等的讨论范围
2. 幂等关注的是以后的多次请求是否对资源产生的副作用，而不关注结果。
3. 第一次请求可以产生副作用，但随后的234次就不会有副作用了



## 二、幂等的作用

幂等是为了简化客户端逻辑处理，却增加了服务提供者的逻辑和成本，是否有必要，需要根据具体场景具体分析。

因此除了业务上的特殊要求外，尽量不提供幂等的接口。

## 三、什么情况下需要幂等

**声明幂等的服务认为，外部调用者会存在多次调用的情况，为了防止外部多次调用对系统数据状态的发生多次改变，将服务设计成幂等。**

例如: 

1. 用户在APP上连续点击了多次提交订单，后台应该只产生一个订单

2. 向支付宝发起支付请求，由于网络问题或系统BUG重发，支付宝应该只扣一次钱

   

上面说的是正常的情况，还有可能是黑客恶意攻击， 比如恶意刷单、刷接口

**总之， 核心的涉及财产、库存、支付、数量的接口，最好都做幂等性设计**




## 四、HTTP对幂等的要求

![img](https://pic1.zhimg.com/80/v2-34042aebd49e8b457cceadf1a465d499_720w.jpg?source=1940ef5c)

## 五、实现策略

1. 唯一的业务号，比如订单号。

   对同一个订单号的操作，比如支付、退款、结算、发货等，都先校验该订单号的这个行为有没有做过

   对于三.1的重复下单问题，可以客户端产生一个随机数(比如UUID)，下单时带上这个UUID，对这个UUID + userId做幂等

   

2. 上面1存在问题，**查询和做**，其实大部分情况是**非原子操作**，高并发情况下可能会有问题，

   那么，接下来问题就变成了数据一致性要怎么实现了：

   - 乐观锁

     例如， UPDATE tab1 SET col1=1,version=version+1 WHERE version=#version#

   - 悲观锁

     - 利用MySQL的行锁，新建一张锁表，获得锁的请求可以操作，没有锁的请求就中止

     - 分布式锁

       参考: [分布式锁](./分布式/分布式锁)

   - token令牌，一般在业务涉及限流 + 幂等的情况下会使用
