# 事务



| 序号 | 问题                              | 一句话解释                                                   | 详细知识点                                                   |
| ---- | --------------------------------- | ------------------------------------------------------------ | ------------------------------------------------------------ |
| 0    | 事务隔离级别                      | 下面的隔离级别，从上往下**越来越严，性能越来越差**<br> 一、读未提交（read uncommitted）<br>二、读提交（read committed）<br>三、可重复读（repeatable read）<br>四、串行化（serializable ） | [三歪连MVCC和事务隔离级别的关系](https://mp.weixin.qq.com/s/0-YEqTMd0OaIhW99WqavgQ) |
| 1    | 事务的隔离级别怎么设置            | 配置的方式是，将启动参数 transaction-isolation 的值设置成 READ-COMMITTED。你可以用 show variables 来查看当前的值 |                                                              |
| 2    | MVCC是什么？和事务隔离级别的关系? | 在查询同一条记录的时候，不同时刻启动的事务会有不同的 read-view。<br>同一条记录在系统中可以存在多个版本，就是数据库的多版本并发控制（MVCC），由undo log实现 |                                                              |
| 3    | MySQL如何保证ACID的               | 隔离性由锁来实现；一致性由undo log来实现；原子性、持久性由redo log来实现 |                                                              |
| 4    | 事务的分类                        | 扁平事务<br>带有保存点的扁平事务<br>链事务<br>嵌套事务<br>分布式事务 |                                                              |





## 0.事务的隔离级别

须知，**隔离级别越高，性能就越差** 

所以我们大多数时候是在性能和数据一致性之间找一个平衡，根据业务的要求



下面的隔离级别，从上往下**越来越严，性能越来越差**

1. 读未提交（read uncommitted）

   原理 : 直接返回，不额外处理

2. 读提交（read committed）

   原理 : **视图**，每个SQL执行的时候创建的视图

3. 可重复读（repeatable read）

   原理 : **视图**， 事务启动时创建的**唯一的**一个视图

4. 串行化（serializable ）

   原理 : 读写锁，后来的线程需要等待



## 2.MVCC是什么



## 3.MySQL如何保证ACID的？

ACID参见 [事务基础](../../../微服务/事务/事务基础)

1. 原子性（**A**tomicity）

   **如果想要保证事务的原子性，就需要在异常发生时，对已经执行的操作进行回滚**

   MySQL通过**回滚日志（undo log）** 实现回滚操作

   > 所有事务进行的修改都会先先记录到这个回滚日志中，然后再执行相关的操作。如果执行过程中遇到异常的话，我们直接利用 **回滚日志** 中的信息将数据回滚到修改之前的样子即可

   **undo会先于数据持久化到磁盘上。这样就保证了即使遇到数据库突然宕机等情况，当用户再次启动数据库的时候，数据库还能够通过查询回滚日志来回滚之前未完成的事务。**

2. 隔离性（**I**solation）

   通过锁

3. 持久性（**D**urability）

   **要实现持久性，就是要在事务提交时，就保证一定落到磁盘了**

   MySQL是通过InnoDb引擎的redo log来 实现持久性的， 当事务提交的时候，会将`redo log`日志进行刷盘

   > redo log频繁刷盘会不会影响性能？ 参考[redoLog](../log/redoLog)

4. 一致性（**C**onsistency）

   **利用的是锁和MVCC机制**




## 4.事务的分类

1. 扁平事务

   - 事务类型中最简单的一种，也是最常用的，

   - 由BEGIN WORK 开始， COMMIT WORK/ ROLLBACK WORK 结束

2. 带有保存点的扁平事务

   允许在事务执行过程中，回滚到同一事务中较早的一个状态 ，类似于"回滚一半"的概念

   > 某些业务情况下，放弃并回滚整个事务不合要求，成本也较高

3. 链事务

   - n个事务之间串联，2能看到事务1的结果； 回滚只能回滚当前事务，比如3；

   - 确定3没问题之后，再往下继续执行事务

4. 嵌套事务 (InnoDB不支持)

   - 父事务包含很多子事务， 子事务既可以是扁平的，也可以是带有保存点的，甚至可以是嵌套的

   - 子事务仅保留ACI特性，不保证D

5. 分布式事务