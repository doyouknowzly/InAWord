# Redis高可用

[toc]



Redis高可用的发展历史

- 主从同步
- Sentinel
- Cluster集群模式



## 主从同步

Redis中的节点分为主、从节点。**主节点写，从节点读**

1. 主节点会异步将数据同步到从节点，不阻塞主节点写入

2. 如果某个主节点不响应Ping了，就会在集群内选举其从节点的一个，作为新的主节点。负责之前的槽位，[选举算法基于Raft]

   

   

复制的策略有：增量同步、快照同步、无盘复制。

1. 大部分时候都是正常的，主、从之间使用增量同步；
   - 但是如果忽然网络不好，导致几秒钟的数据没有同步。
   - 等到网络恢复的时候，再使用增量同步肯定不行
2. 网络恢复以后，要使用更复杂的快照同步
   - 先使用bgsave，将主节点的数据快照到磁盘
   - 然后将磁盘数据通过网络完整地传给从节点
   - 从节点接受完毕后，要清除自己的数据，然后加载刚才同步的数据



## Sentinel

在 Redis 3.0 之前，只能使用 哨兵（sentinel）机制来监控各个节点之间的状态。哨兵节点只能作监控使用，本质是额外启动哨兵节点去监控数据节点。



## Cluster集群模式

Redis Cluster 是 Redis 的 分布式解决方案，在 3.0 版本正式推出，有效地解决了 Redis 在 分布式 方面的需要<br>(0)主节点负责写，从节点只能读，且会同步来自主节点的命令

(1)使用cluster meet命令将节点连接

(2)通过Gossip协议来交换各自关于不同节点的状态信息

(3)数据分片,16384(1024\*2\*8)个槽，数据结构是bitmap,每一位表示一个槽。每个主-从节点负责一部分槽, 使用CRC16(key)&16384来决定key的归属

**优点**：

- 解决横向扩容问题；
- 数据节点自己进行决策，不需要浪费资源部署哨兵节点。



| 序号 | 问题                         | 一句话总结                                                   |
| ---- | ---------------------------- | ------------------------------------------------------------ |
| 3    | 1个节点down掉，redis怎么处理 | 一、各个节点定期互相Ping(自己的Ping命令，不是TCP的Ping), 如果节点7000Ping不通，就将本地缓存的节点7000的ClusterNode对象标记其为PFAIL(疑似下线状态)<br>二、各个节点互相还会同步自己的缓存；同时将其他节点节点对7000的状态存在ClusterNode的一个链表里<br>三、如果一个集群中，过半的主节点都认为7000疑似下线了，就会有一个节点标记7000为FAIL下线，并发广播通知；其他收到广播的节点也会将其标记为FAIL下线 |
| 4    | 故障转移                     | 一、当7000的一个从节点发现7000处于FAIL状态了，就会通知其他主节点，其他主节点就会在所有7000的从节点内**选一个作为主节点(即选举)**，<br>二、然后将主节点的槽全部指派给自己<br>三、向集群发一条广播的PONG消息，通知其他节点自己是主节点啦 |
| 5    | 选举主节点                   | 当过半的主节点都vote给了一个从节点，这个从节点就成为那部分槽的主节点<br>如果没有过半的，就重新选举，直到过半<br>选举算法是基于Raft的领头选举的 |

