# Key过期策略

[toc]

### 零、引言

如果一个键过期了，那么它什么时候会被删除呢？
这个问题有三种可能的答案，它们分别代表了三种不同的删除策略：

- 定时删除：

  在设置键的过期时间的同时，创建一个定时器（timer），让定时器在键的过期时间来临时，立即执行对键的删除操作。

- 惰性删除：

  放任键过期不管，但是每次从键空间中获取键时，都检查取得的键是否过期，如果过期的话，就删除该键；如果没有过期，就返回该键。

- 定期删除：

  每隔一段时间，程序就对数据库进行一次检查，删除里面的过期键。至于要删除多少过期键，以及要检查多少个数据库，则由算法决定。
  在这三种策略中，第一种和第三种为主动删除策略，而第二种则为被动删除策略

> 如果要实现"到期立即删除"，CPU可能经常要切换，去检查是否有快过期的key，比较影响性能
>
> Redis的作者也想到了，没有使用简单的"到期立即删除"逻辑。



### 一、思路

	#### Redis同时使用了**惰性删除**和**定期删除**。

定时删除是集中处理，惰性删除是零散处理。

- 定期删除

  Redis 会将每个设置了过期时间的 key 放入到一个独立的字典中，以后会定时遍历这个 字典来删除到期的 key。

- 惰性删除

  就是在客户端访问这个 key 的时候，redis 对 key 的过期时间进行检查，如果过期了就立即删除。

​	



### 二、具体策略

定期策略: 

Redis 默认会每秒进行十次过期扫描，过期扫描不会遍历过期字典中所有的 key，而是 采用了一种简单的贪心策略。

1. 从过期字典中随机 20 个 key； 
2. 删除这 20 个 key 中已经过期的 key； 
3. 如果过期的 key 比率超过 1/4，那就重复步骤 1；



同时，为了保证过期扫描不会出现循环过度，导致线程卡死现象，算法还增加了扫描时 间的上限，默认不会超过 25ms。



### 三、持久化时的过期key

1. 执行SAVE命令或者BGSAVE命令所产生的新RDB文件不会包含已经过期的键。
2. 执行BGREWRITEAOF命令所产生的重写AOF文件不会包含已经过期的键。
3. 当一个过期键被删除之后，服务器会追加一条DEL命令到现有AOF文件的末尾，显式地删除过期键。